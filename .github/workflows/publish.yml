name: Publish Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  publish:
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout abrarion
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      - name: Build universal binary
        run: swift build -c release --arch arm64 --arch x86_64
      
      - name: Create release package
        id: package
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          mkdir -p .release
          cp .build/apple/Products/Release/abrarion .release/
          cd .release
          tar -czf abrarion-${VERSION}.tar.gz abrarion
          SHA256=$(shasum -a 256 abrarion-${VERSION}.tar.gz | cut -d ' ' -f 1)
          echo "SHA256=${SHA256}" >> $GITHUB_OUTPUT
          echo "TARBALL=abrarion-${VERSION}.tar.gz" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: .release/${{ steps.package.outputs.TARBALL }}
          generate_release_notes: true
      
      - name: Clone homebrew-abrarion
        run: |
          git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/autoasset/homebrew-abrarion.git .release/homebrew-abrarion
      
      - name: Update Homebrew formula
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          SHA256=${{ steps.package.outputs.SHA256 }}
          cat > .release/homebrew-abrarion/Formula/abrarion.rb << EOF
          class Abrarion < Formula
            desc "任务编排工具"
            homepage "https://github.com/autoasset/homebrew-abrarion"
            url "https://github.com/autoasset/homebrew-abrarion/releases/download/${VERSION}/abrarion-${VERSION}.tar.gz"
            sha256 "${SHA256}"
            def install
              bin.install "abrarion"
            end
            test do
              system "false"
            end
          end
          EOF
      
      - name: Sync Documentation and README
        run: |
          rm -rf .release/homebrew-abrarion/Documentation
          cp -r Documentation .release/homebrew-abrarion/
          cp README.md .release/homebrew-abrarion/
      
      - name: Commit and push to homebrew-abrarion
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          cd .release/homebrew-abrarion
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "${VERSION}"
          git push
          # Delete existing tag if exists
          git tag -d "${VERSION}" 2>/dev/null || true
          git push origin ":refs/tags/${VERSION}" 2>/dev/null || true
          # Create and push new tag
          git tag "${VERSION}"
          git push origin "${VERSION}"

